<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dep√≥sito - Totales por Pedido</title>
  <style>
    :root {
      --verde:#16a34a;
      --violeta:#7c3aed;
      --gris:#f8fafc;
      --borde:#e5e7eb;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background:#fff;
      color:#111;
    }
    header {
      position: sticky; top:0; z-index:10;
      background:#fff; padding:12px 20px;
      border-bottom:1px solid var(--borde);
    }
    h1 { color:var(--violeta); margin:0 0 8px; }
    .filtros { display:flex; gap:8px; flex-wrap:wrap; }
    input,select,button {
      padding:6px 10px; border:1px solid var(--borde); border-radius:6px;
    }
    button { cursor:pointer; font-weight:600; }
    .btn-green{background:var(--verde);color:#fff;border:0;}
    .btn-purple{background:var(--violeta);color:#fff;border:0;}
    .contenedor { padding:20px; max-width:900px; margin:auto; }
    .pedido {
      border:1px solid var(--borde);
      border-radius:10px;
      padding:12px;
      margin-bottom:16px;
      background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,.05);
    }
    .pedido.reciente { background:#ecfdf5; border-left:5px solid var(--verde); }
    .pedido.ayer { background:#f5f3ff; border-left:5px solid var(--violeta); }
    h3 { margin:0 0 8px; color:var(--violeta); }
    .total { font-weight:bold; color:var(--verde); }
    #resumen {
      background:var(--gris); padding:12px;
      border-radius:8px; margin-bottom:20px;
    }
    #resumen h2{margin-top:0;color:var(--verde);}
    .acciones { display:flex; gap:8px; margin-top:12px; }
    .estado-select { margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Totales de Pedidos - SION S.R.L</h1>
    <div class="filtros">
      <input type="text" id="filtroSucursal" placeholder="Sucursal..." />
      <input type="date" id="filtroFecha" />
      <div class="acciones">
        <button class="btn-green" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn-purple" onclick="exportarPDF()">‚¨áÔ∏è Exportar PDF</button>
      </div>
    </div>
  </header>

  <div class="contenedor">
    <div id="resumen"></div>
    <div id="contenedor"></div>
    <div id="totalGeneral"></div>
  </div>

  <!-- jsPDF para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, query, orderBy, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr0SM_u0c4aEG_tT_CXWLcvd6alZJT44c",
      authDomain: "siondata22.firebaseapp.com",
      projectId: "siondata22",
      storageBucket: "siondata22.appspot.com",
      messagingSenderId: "946379205241",
      appId: "1:946379205241:web:0fe04a6246518451ee42a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const contenedor = document.getElementById("contenedor");
    const resumen = document.getElementById("resumen");
    const totalGeneralEl = document.getElementById("totalGeneral");

    const filtroSucursal = document.getElementById("filtroSucursal");
    const filtroFecha = document.getElementById("filtroFecha");

    let pedidosHTML = [];
    let mapaPrecios = {}; // üëà aqu√≠ guardamos los precios de productos

    onAuthStateChanged(auth, async user => {
      if (user) {
        await cargarProductos();   // primero cargar todos los productos
        await cargarPedidos();     // luego cargar pedidos
      }
    });

    async function cargarProductos() {
      const productosSnap = await getDocs(collection(db, "productos"));
      productosSnap.forEach(d => {
        mapaPrecios[d.id] = d.data().precio || 0;
      });
    }

    async function cargarPedidos() {
      contenedor.innerHTML = "<p>Cargando pedidos...</p>";
      const q = query(collection(db, "pedidos"), orderBy("fecha", "desc"));
      const pedidosSnapshot = await getDocs(q);
      const resumenSucursal = {};
      pedidosHTML = [];
      contenedor.innerHTML = "";

      let totalGeneral = 0;

      for (const docPedido of pedidosSnapshot.docs) {
        const pedido = docPedido.data();
        const productos = pedido.productos || [];
        let total = 0;

        // ahora usamos el mapa de precios en memoria
        for (const p of productos) {
          const precio = mapaPrecios[p.productoId] || 0;
          total += precio * p.cantidad;
        }

        const fechaPedido = new Date(pedido.fecha);
        const hoy = new Date();
        let clase = "";
        if (fechaPedido.toDateString() === hoy.toDateString()) clase = "reciente";
        else if (fechaPedido.toDateString() === new Date(hoy.setDate(hoy.getDate()-1)).toDateString()) clase = "ayer";

        const estado = pedido.estado || "pendiente";
        const estadoSelect = `
          <label>Estado:
            <select class="estado-select" data-id="${docPedido.id}">
              <option value="pendiente" ${estado === "pendiente" ? "selected" : ""}>Pendiente</option>
              <option value="preparando" ${estado === "preparando" ? "selected" : ""}>Preparando</option>
              <option value="enviado" ${estado === "enviado" ? "selected" : ""}>Enviado</option>
            </select>
          </label>
        `;

        const div = document.createElement("div");
        div.className = "pedido " + clase;
        div.dataset.sucursal = (pedido.sucursal||"").toLowerCase();
        div.dataset.fecha = fechaPedido.toISOString().split("T")[0];
        div.innerHTML = `
          <h3>${pedido.sucursal} - ${fechaPedido.toLocaleString()}</h3>
          ${estadoSelect}
          <div class="total">Total Pedido: Gs. ${total.toLocaleString()}</div>
        `;
        contenedor.appendChild(div);
        pedidosHTML.push(div);

        resumenSucursal[pedido.sucursal] = (resumenSucursal[pedido.sucursal]||0)+total;
        totalGeneral += total;
      }

      generarResumen(resumenSucursal);
      totalGeneralEl.textContent = "üî¢ Total General: Gs. " + totalGeneral.toLocaleString();
      agregarListenersEstado();
    }

    function generarResumen(resumenSucursal) {
      resumen.innerHTML = "<h2>Resumen por Sucursal</h2><ul>" +
        Object.entries(resumenSucursal).map(([suc, total]) =>
          `<li>${suc}: <strong>Gs. ${total.toLocaleString()}</strong></li>`).join("") +
        "</ul>";
    }

    function agregarListenersEstado() {
      document.querySelectorAll(".estado-select").forEach(select => {
        select.addEventListener("change", async () => {
          const id = select.dataset.id;
          const estado = select.value;
          await updateDoc(doc(db, "pedidos", id), { estado });
          select.style.background = (estado==="enviado"? "#bbf7d0" : estado==="preparando"? "#ede9fe":"#fff");
        });
      });
    }

    filtroSucursal.addEventListener("input", filtrar);
    filtroFecha.addEventListener("change", filtrar);

    function filtrar() {
      const suc = filtroSucursal.value.toLowerCase();
      const fecha = filtroFecha.value;
      pedidosHTML.forEach(div => {
        const coincideSucursal = div.dataset.sucursal.includes(suc);
        const coincideFecha = !fecha || div.dataset.fecha === fecha;
        div.style.display = coincideSucursal && coincideFecha ? "" : "none";
      });
    }

    // Exportar a PDF en vez de Excel
    window.exportarPDF = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Resumen de Pedidos - SION S.R.L", 14, 20);
      doc.setFontSize(10);
      doc.text("Generado: " + new Date().toLocaleString(), 14, 28);

      let y = 40;
      doc.setFontSize(12);
      doc.text("Totales por Sucursal:", 14, y);

      document.querySelectorAll("#resumen li").forEach(li => {
        y += 8;
        doc.text(li.innerText, 20, y);
      });

      y += 12;
      doc.setFontSize(14);
      doc.text(document.getElementById("totalGeneral").textContent, 14, y);

      doc.save("resumen_pedidos.pdf");
    }
  </script>
</body>
</html>

