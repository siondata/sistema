<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Nuevo Pedido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      border: 3px solid rgb(255, 0, 255);
      border-radius: 10px;
    }
    input, select, textarea, button {
      font-size: 16px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      background-color: #3498db;
      color: white;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }
    .remove-item-button {
      background-color: #dc3545;
      padding: 5px 10px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      margin-left: 10px;
    }
    .remove-item-button:hover {
      background-color: #c82333;
    }
    .product-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .product-item input.producto-input {
      flex: 2;
      padding: 8px;
    }
    .product-item input.cantidad-input {
      width: 80px;
      padding: 8px;
    }
    #addProductoBtn {
      margin-top: 15px;
      border-radius: 15px;
      width: 100%;
    }
    #enviarproducto {
      margin-top: 20px;
      border-radius: 15px;
      width: 100%;
      background-color: green;
    }
    #enviarproducto:hover {
      background-color: darkgreen;
    }
    #mensaje {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Nuevo Pedido</h1>
  <form id="pedidoForm">
    <label for="sucursal">Sucursal:</label>
    <select id="sucursal" required>
      <option value="">Seleccione una sucursal</option>
      <option value="Sucursal KM5">Sucursal KM5</option>
      <option value="Sucursal KM7">Sucursal KM7</option>
      <option value="Sucursal KM8">Sucursal KM8</option>
      <option value="Sucursal GSS">Sucursal GSS</option>
    </select>

    <h2>Productos</h2>
    
    <!-- Datalist para autocompletar productos -->
    <datalist id="productosList"></datalist>

    <div id="productosContainer"></div>

    <button id="addProductoBtn" type="button">Añadir otro producto</button>

    <label for="comentarios">Comentarios:</label>
    <textarea id="comentarios" placeholder="Comentarios adicionales (opcional)" rows="3"></textarea>

    <button id="enviarproducto" type="submit">Enviar Pedido</button>
  </form>

  <p id="mensaje"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tu configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCr0SM_u0c4aEG_tT_CXWLcvd6alZJT44c",
      authDomain: "siondata22.firebaseapp.com",
      projectId: "siondata22",
      storageBucket: "siondata22.appspot.com",
      messagingSenderId: "946379205241",
      appId: "1:946379205241:web:0fe04a6246518451ee42a8",
      measurementId: "G-EX6YDJYS1N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const productosContainer = document.getElementById('productosContainer');
    const addProductoBtn = document.getElementById('addProductoBtn');
    const mensaje = document.getElementById('mensaje');
    const form = document.getElementById('pedidoForm');
    const datalist = document.getElementById('productosList');

    let productosDisponibles = [];

    // Verificar usuario logueado
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        cargarProductos();
        addProductItem();
      }
    });

    // Cargar productos desde Firestore y actualizar datalist
    async function cargarProductos() {
      productosDisponibles = [];
      datalist.innerHTML = "";
      const snapshot = await getDocs(collection(db, "productos"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.stock > 0) {
          productosDisponibles.push({ id: docSnap.id, ...data });
          const option = document.createElement("option");
          option.value = `${data.nombre} - Stock: ${data.stock} - Gs. ${data.precio.toLocaleString()}`;
          option.dataset.id = docSnap.id;
          datalist.appendChild(option);
        }
      });
    }

    // Añadir nuevo producto al formulario
    function addProductItem() {
      const div = document.createElement('div');
      div.classList.add('product-item');
      div.innerHTML = `
        <input class="producto-input" list="productosList" placeholder="Buscar producto" required autocomplete="off" />
        <input type="number" class="cantidad-input" placeholder="Cantidad" min="1" required />
        <button type="button" class="remove-item-button" title="Eliminar producto">X</button>
      `;
      const btnRemove = div.querySelector('.remove-item-button');
      btnRemove.addEventListener('click', () => {
        div.remove();
        toggleRemoveButtons();
      });
      productosContainer.appendChild(div);
      toggleRemoveButtons();
    }

    // Mostrar/ocultar botón eliminar según cantidad de productos
    function toggleRemoveButtons() {
      const items = document.querySelectorAll('.product-item');
      items.forEach(item => {
        const btn = item.querySelector('.remove-item-button');
        btn.style.display = items.length > 1 ? 'inline-block' : 'none';
      });
    }

    addProductoBtn.addEventListener('click', addProductItem);
    toggleRemoveButtons();

    form.addEventListener('submit', async e => {
      e.preventDefault();
      mensaje.textContent = "";

      const sucursal = document.getElementById('sucursal').value;
      const comentarios = document.getElementById('comentarios').value;

      const items = document.querySelectorAll('.product-item');
      const productosUsados = new Set();
      const itemsPedido = [];

      for (const item of items) {
        const inputText = item.querySelector('.producto-input').value.trim();
        const cantidad = parseInt(item.querySelector('.cantidad-input').value);

        // Buscar producto que coincida por nombre al inicio del texto
        const producto = productosDisponibles.find(p => inputText.startsWith(p.nombre));
        if (!producto) {
          mensaje.textContent = `❌ Producto "${inputText}" no válido.`;
          return;
        }
        if (isNaN(cantidad) || cantidad < 1) {
          mensaje.textContent = `❌ Cantidad inválida para "${producto.nombre}".`;
          return;
        }
        if (cantidad > producto.stock) {
          mensaje.textContent = `❌ La cantidad para "${producto.nombre}" supera el stock disponible (${producto.stock}).`;
          return;
        }
        if (productosUsados.has(producto.id)) {
          mensaje.textContent = `❌ El producto "${producto.nombre}" está repetido.`;
          return;
        }
        productosUsados.add(producto.id);
        itemsPedido.push({ productoId: producto.id, nombre: producto.nombre, cantidad });
      }

      try {
        // Agregar pedido a Firestore
        await addDoc(collection(db, "pedidos"), {
          fecha: new Date().toISOString(),
          sucursal,
          comentarios,
          productos: itemsPedido
        });

        // Actualizar stock en Firestore
        for (const item of itemsPedido) {
          const ref = doc(db, "productos", item.productoId);
          const snap = await getDoc(ref);
          const nuevoStock = (snap.data().stock || 0) - item.cantidad;
          await updateDoc(ref, { stock: nuevoStock });
        }

        mensaje.style.color = "green";
        mensaje.textContent = "✅ Pedido enviado correctamente.";

        // Limpiar formulario para nuevo pedido
        form.reset();
        productosContainer.innerHTML = "";
        addProductItem();
        cargarProductos();

      } catch (error) {
        mensaje.style.color = "red";
        mensaje.textContent = "❌ Error al guardar el pedido.";
        console.error(error);
      }
    });
  </script>

</body>
</html>

