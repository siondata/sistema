<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Pedidos - SION S.R.L.</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --violeta: #810b81;  /* violeta */
      --verde:#1b6d39;    /* verde */
      --bg:#f8fafc;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#64748b;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:16px;background:var(--bg);color:var(--text)}
    h1{margin:0 0 12px;color:var(--violeta)}
    h3{margin:6px 0 8px 0;color:var(--violeta)}
    .container{display:flex;gap:16px;flex-wrap:wrap}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.04);flex:1 1 420px}
    label{display:block;margin-top:8px;font-weight:600}
    input[type="text"], input[type="number"], select, textarea{
      width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;outline:none
    }
    input:focus, select:focus, textarea:focus{border-color:var(--violeta);box-shadow:0 0 0 3px rgba(124,58,237,.15)}
    .row{display:flex;gap:8px;align-items:end;flex-wrap:wrap}
    .row > *{flex:1}
    .badge{display:inline-block;font-size:.8rem;padding:2px 8px;border-radius:999px;background:rgba(22,163,74,.1);color:var(--verde);border:1px solid rgba(22,163,74,.25)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    .small{font-size:.9rem;color:var(--muted)}
    .precio-display{min-width:120px;display:inline-block;font-weight:700;color:var(--verde)}
    button{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--verde);color:#fff}
    .btn-secondary{background:var(--violeta);color:#fff}
    .btn-ghost{background:#f1f5f9;color:#111}
    .btn-danger{background:#ef4444;color:#fff}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    #mensaje{margin-top:10px}
    @media (max-width:860px){ .container{flex-direction:column} }
  </style>
</head>
<body>
  <h1>Sion Productos</h1>

  <div class="container">
    <!-- Panel izquierdo: formulario / buscadores -->
    <div class="panel" id="panel-form">
      <form id="pedidoForm">
        <label for="sucursal">Sucursal</label>
        <select id="sucursal" required>
          <option value="">Seleccione una sucursal</option>
          <option value="Sucursal KM5">Sucursal KM5</option>
          <option value="Sucursal KM7">Sucursal KM7</option>
          <option value="Sucursal KM8">Sucursal KM8</option>
          <option value="Sucursal GSS">Sucursal GSS</option>
        </select>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="productoSelect">Buscar por nombre</label>
            <input id="productoSelect" type="text" list="productosList" placeholder="Escriba nombre..." autocomplete="off">
            <datalist id="productosList"></datalist>
            <div class="small">Sugerencias: <span class="badge">nombre</span> + precio</div>
          </div>
          <div>
            <label for="barcodeInput">Buscar por c√≥digo de barras</label>
            <input id="barcodeInput" type="text" inputmode="numeric" placeholder="Escanee o escriba el c√≥digo..." autocomplete="off">
            <div class="small">Compatible con <span class="badge">codigoBarra</span>, <span class="badge">codigo</span>, <span class="badge">barcode</span></div>
          </div>
        </div>

        <div class="row" style="margin-top:8px;align-items:center">
          <div style="flex:1">
            <label class="small">Precio</label>
            <div class="precio-display" id="precioSelected">Gs. 0</div>
          </div>
          <div style="width:130px">
            <label for="cantidadToAdd">Cantidad</label>
            <input id="cantidadToAdd" type="number" min="1" value="1">
          </div>
          <div style="width:180px">
            <button type="button" id="addToCartBtn" class="btn-secondary">Agregar al carrito</button>
          </div>
        </div>

        <label for="comentarios">Comentarios</label>
        <textarea id="comentarios" rows="3" placeholder="Comentarios (opcional)"></textarea>

        <div style="margin-top:12px" class="row" >
          <button id="enviarPedidoBtn" type="submit" class="btn-primary">Enviar Pedido</button>
          <button id="limpiarBtn" type="button" class="btn-ghost">Limpiar carrito</button>
        </div>
      </form>

      <p id="mensaje" class="small"></p>
    </div>

    <!-- Panel derecho: carrito -->
    <div class="panel" id="panel-cart">
      <h3>Carrito</h3>
      <div id="cartCount" class="small">0 √≠tems</div>

      <table id="cartTable" aria-label="Carrito de productos">
        <thead>
          <tr><th>Producto</th><th>Precio U.</th><th>Cantidad</th><th>Subtotal</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 id="total" style="text-align:right">Total: Gs. 0</h3>

      <div class="actions">
        <button id="printBtn" type="button" class="btn-ghost">Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Firebase + l√≥gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr0SM_u0c4aEG_tT_CXWLcvd6alZJT44c",
      authDomain: "siondata22.firebaseapp.com",
      projectId: "siondata22",
      storageBucket: "siondata22.appspot.com",
      messagingSenderId: "946379205241",
      appId: "1:946379205241:web:0fe04a6246518451ee42a8",
      measurementId: "G-EX6YDJYS1N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const datalist = document.getElementById("productosList");
    const productoSelect = document.getElementById("productoSelect");
    const barcodeInput = document.getElementById("barcodeInput");
    const precioSelected = document.getElementById("precioSelected");
    const cantidadToAdd = document.getElementById("cantidadToAdd");
    const addToCartBtn = document.getElementById("addToCartBtn");
    const cartTableBody = document.querySelector("#cartTable tbody");
    const totalEl = document.getElementById("total");
    const cartCountEl = document.getElementById("cartCount");
    const mensaje = document.getElementById("mensaje");
    const limpiarBtn = document.getElementById("limpiarBtn");
    const printBtn = document.getElementById("printBtn");
    const form = document.getElementById("pedidoForm");

    // Datos en memoria
    let productosDisponibles = []; // {id,nombre,precio,stock,codigoBarra}
    const displayToProduct = new Map(); // "Nombre - Gs. 10.000" => producto
    const barcodeToProduct = new Map(); // "789..." => producto
    let cartItems = []; // {productId,nombre,precio,cantidad}
    let vendedorEmail = "";

    // Sesi√≥n
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      vendedorEmail = user.email || user.uid || "vendedor";
    });

    // Util: seleccionar un producto y reflejar precio/campos
    function seleccionarProducto(prod){
      if(!prod) return;
      productoSelect.value = prod.nombre || "";
      productoSelect.dataset.productId = prod.id;
      productoSelect.dataset.precio = String(prod.precio || 0);
      precioSelected.textContent = `Gs. ${Number(prod.precio||0).toLocaleString()}`;
      // setear cantidad 1 por defecto si est√° vac√≠a
      if(!cantidadToAdd.value || Number(cantidadToAdd.value) < 1) cantidadToAdd.value = 1;
    }

    // Cargar productos
    async function cargarProductos() {
      productosDisponibles = [];
      displayToProduct.clear();
      barcodeToProduct.clear();
      datalist.innerHTML = "";
      try {
        const snap = await getDocs(collection(db, "productos"));
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const nombre = String(data.nombre || "").trim();
          const precio = Number(data.precio || 0);
          const stock = Number(data.stock || 0);
          const codigoBarra = String(
            data.codigoBarra ?? data.codigo ?? data.codBarra ?? data.barcode ?? data.bar_code ?? ""
          ).trim();

          const prod = { id: docSnap.id, nombre, precio, stock, codigoBarra };
          productosDisponibles.push(prod);

          // Datalist por nombre
          const display = `${nombre} - Gs. ${precio.toLocaleString()}`;
          const opt = document.createElement("option");
          opt.value = display;
          datalist.appendChild(opt);
          displayToProduct.set(display, prod);

          // √çndice por c√≥digo
          if (codigoBarra) {
            barcodeToProduct.set(codigoBarra, prod);
          }
        });
      } catch (err) {
        console.error("Error cargando productos:", err);
        mensaje.textContent = "Error cargando cat√°logo de productos.";
      }
    }

    // Buscar por nombre (datalist)
    productoSelect.addEventListener("input", () => {
      const texto = productoSelect.value.trim();
      let prod = null;

      if (displayToProduct.has(texto)) {
        prod = displayToProduct.get(texto);
      } else {
        const matches = productosDisponibles.filter(p => p.nombre.toLowerCase() === texto.toLowerCase());
        if (matches.length === 1) prod = matches[0];
      }

      if (prod) {
        seleccionarProducto(prod);
      } else {
        delete productoSelect.dataset.productId;
        delete productoSelect.dataset.precio;
        precioSelected.textContent = `Gs. 0`;
      }
    });

    // Buscar por c√≥digo de barras
    function intentarMatchPorCodigo(valor){
      const code = String(valor || "").trim();
      if(!code) return null;

      // match exacto
      if (barcodeToProduct.has(code)) {
        return barcodeToProduct.get(code);
      }
      // match tolerante (si el esc√°ner agrega sufijo/prefijo)
      const candidato = Array.from(barcodeToProduct.keys()).find(k => k && (code.includes(k) || k.includes(code)));
      return candidato ? barcodeToProduct.get(candidato) : null;
    }

    barcodeInput.addEventListener("input", () => {
      const prod = intentarMatchPorCodigo(barcodeInput.value);
      if (prod) seleccionarProducto(prod);
    });

    barcodeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const prod = intentarMatchPorCodigo(barcodeInput.value);
        if (prod) {
          seleccionarProducto(prod);
          // si ya tenemos producto y cantidad v√°lida, permitir agregar r√°pido
          if (Number(cantidadToAdd.value) > 0) addToCart();
        } else {
          mensaje.textContent = "C√≥digo no encontrado.";
        }
      }
    });

    // Agregar al carrito (funci√≥n + bot√≥n)
    function addToCart(){
      mensaje.textContent = "";
      const nombre = productoSelect.value.trim();
      const productId = productoSelect.dataset.productId || "";
      const precio = Number(productoSelect.dataset.precio || 0);
      const cantidad = parseInt(cantidadToAdd.value) || 0;

      if (!productId || !nombre) {
        mensaje.textContent = "Seleccione un producto v√°lido por nombre o c√≥digo.";
        return;
      }
      if (cantidad <= 0) {
        mensaje.textContent = "Ingrese una cantidad v√°lida (> 0).";
        return;
      }

      const prodInfo = productosDisponibles.find(p => p.id === productId);
      if (!prodInfo) {
        mensaje.textContent = "Producto no v√°lido (recargue la p√°gina).";
        return;
      }
      const existente = cartItems.find(it => it.productId === productId);
      const totalSolicitado = (existente ? existente.cantidad : 0) + cantidad;
      if (totalSolicitado > (prodInfo.stock || 0)) {
        mensaje.textContent = `Stock insuficiente. Disponible: ${prodInfo.stock}`;
        return;
      }

      if (existente) existente.cantidad += cantidad;
      else cartItems.push({ productId, nombre, precio, cantidad });

      // limpiar selecci√≥n
      productoSelect.value = "";
      barcodeInput.value = "";
      delete productoSelect.dataset.productId;
      delete productoSelect.dataset.precio;
      precioSelected.textContent = `Gs. 0`;
      cantidadToAdd.value = 1;

      renderCart();
    }

    addToCartBtn.addEventListener("click", addToCart);

    // Render carrito
    function renderCart() {
      cartTableBody.innerHTML = "";
      let total = 0;
      let count = 0;
      cartItems.forEach(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal; count += item.cantidad;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.nombre}</td>
          <td>Gs. ${Number(item.precio).toLocaleString()}</td>
          <td><input type="number" min="1" value="${item.cantidad}" data-product-id="${item.productId}" class="qty-input" style="width:90px;padding:8px;border-radius:10px;border:1px solid #cbd5e1"></td>
          <td>Gs. ${subtotal.toLocaleString()}</td>
          <td><button class="btn-danger remove-btn" data-product-id="${item.productId}" title="Eliminar">üóëÔ∏è</button></td>
        `;
        cartTableBody.appendChild(tr);
      });

      totalEl.textContent = `Total: Gs. ${total.toLocaleString()}`;
      cartCountEl.textContent = `${count} √≠tems`;

      // qty change / remove
      document.querySelectorAll(".qty-input").forEach(input => {
        input.addEventListener("change", () => {
          const pid = input.dataset.productId;
          let newQty = parseInt(input.value) || 1;
          if (newQty < 1) newQty = 1;
          const prodInfo = productosDisponibles.find(p => p.id === pid);
          if (newQty > (prodInfo.stock || 0)) {
            mensaje.textContent = `Stock insuficiente para ${prodInfo.nombre}. Disponible: ${prodInfo.stock}`;
            input.value = prodInfo.stock || 1;
            newQty = parseInt(input.value);
          } else {
            mensaje.textContent = "";
          }
          const item = cartItems.find(it => it.productId === pid);
          if (item) item.cantidad = newQty;
          renderCart();
        });
      });

      document.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const pid = btn.dataset.productId;
          cartItems = cartItems.filter(it => it.productId !== pid);
          renderCart();
        });
      });
    }

    // Limpiar carrito
    limpiarBtn.addEventListener("click", () => {
      cartItems = [];
      renderCart();
      mensaje.textContent = "Carrito limpiado.";
    });

    // Imprimir (simple)
    printBtn.addEventListener("click", () => {
      const win = window.open("", "_blank");
      const rowsHtml = cartItems.map(it => `<tr><td>${it.nombre}</td><td>${it.cantidad}</td><td>Gs. ${it.precio.toLocaleString()}</td><td>Gs. ${(it.precio*it.cantidad).toLocaleString()}</td></tr>`).join("");
      const total = cartItems.reduce((s,it)=>s+it.precio*it.cantidad,0);
      win.document.write(`
        <html><head><title>Ticket</title></head><body>
        <h2 style="color:#7c3aed">Pedido - ${new Date().toLocaleString()}</h2>
        <table border="1" cellpadding="6" cellspacing="0">
        <tr><th>Producto</th><th>Cantidad</th><th>Precio U.</th><th>Subtotal</th></tr>
        ${rowsHtml}
        <tr><td colspan="3" style="text-align:right"><strong>Total</strong></td><td><strong>Gs. ${total.toLocaleString()}</strong></td></tr>
        </table>
        </body></html>
      `);
      win.document.close();
      win.print();
    });

    // Enviar pedido
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      mensaje.textContent = "";

      const sucursal = document.getElementById("sucursal").value;
      const comentarios = document.getElementById("comentarios").value;

      if (!sucursal) { mensaje.textContent = "Seleccione una sucursal."; return; }
      if (cartItems.length === 0) { mensaje.textContent = "El carrito est√° vac√≠o."; return; }

      try {
        // Verificaci√≥n de stock en tiempo real
        for (const it of cartItems) {
          const snap = await getDoc(doc(db, "productos", it.productId));
          const currentStock = Number(snap?.data()?.stock ?? 0);
          if (it.cantidad > currentStock) {
            mensaje.textContent = `Stock insuficiente para ${it.nombre}. Disponible: ${currentStock}`;
            return;
          }
        }

        const pedidoObj = {
          fecha: new Date().toISOString(),
          sucursal,
          vendedor: vendedorEmail,
          comentarios,
          productos: cartItems.map(it => ({ productoId: it.productId, nombre: it.nombre, cantidad: it.cantidad, precioUnitario: it.precio })),
          total: cartItems.reduce((s,it)=>s+it.precio*it.cantidad,0),
          estado: "pendiente"
        };

        await addDoc(collection(db, "pedidos"), pedidoObj);

        // Descontar stock
        for (const it of cartItems) {
          const prodRef = doc(db, "productos", it.productId);
          const snap = await getDoc(prodRef);
          const currentStock = Number(snap.data().stock || 0);
          await updateDoc(prodRef, { stock: currentStock - it.cantidad });
        }

        mensaje.textContent = "‚úÖ Pedido enviado correctamente.";
        cartItems = [];
        renderCart();
        form.reset();
        precioSelected.textContent = `Gs. 0`;
        await cargarProductos();
      } catch (err) {
        console.error("Error al enviar pedido:", err);
        mensaje.textContent = "‚ùå Error al enviar pedido. Revisa la consola.";
      }
    });

    // Init
    (async function init(){
      await cargarProductos();
      renderCart();
    })();
  </script>
</body>
</html>

