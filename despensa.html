<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Pedidos Sion S.R.L</title>
  <style>
    body{font-family:Arial, sans-serif;margin:0;background:#f6f6f6}
    header{padding:10px 16px;background:#fff;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ddd}
    main{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:20px}
    h2{margin-top:0;font-size:18px}
    input,select,button{padding:8px;border-radius:8px;border:1px solid #ccc;font:inherit}
    button{cursor:pointer}
    .btn{background:#0d6efd;color:#fff;border:0}
    .btn-warn{background:#dc3545;color:#fff;border:0}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px}
    th{background:#fafafa;text-align:left}
    .right{text-align:right}
    #loginView{display:flex;justify-content:center;align-items:center;height:100vh}
    #loginBox{background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.1);width:300px;text-align:center}
    #appView{display:none}
    .cat-buttons{margin:8px 0;display:flex;flex-wrap:wrap;gap:6px}
    .cat-buttons button{background:#6c757d;color:#fff;border:0;padding:6px 10px;border-radius:6px;font-size:12px;cursor:pointer}
    #resultadosBusqueda{background:#fff;border:1px solid #ccc;max-height:200px;overflow-y:auto;position:absolute;width:300px;z-index:1000}
    #resultadosBusqueda div{padding:6px;cursor:pointer}
    #resultadosBusqueda div:hover{background:#f0f0f0}
  </style>
</head>
<body>
  <!-- Login -->
  <section id="loginView">
    <div id="loginBox">
      <h2>Iniciar sesi√≥n</h2>
      <input type="email" id="email" placeholder="Correo"><br>
      <input type="password" id="password" placeholder="Contrase√±a"><br>
      <button id="loginBtn" class="btn">Entrar</button>
      <div id="msg" style="color:red;font-size:12px;margin-top:8px"></div>
    </div>
  </section>

  <!-- App -->
  <section id="appView">
    <header>
      <h1>üßæ Sistema de Pedidos Sion Productos </h1>
      <div>
        <span id="userEmail" style="font-size:12px;color:#555;margin-right:10px"></span>
        <button id="logoutBtn" class="btn-warn">Salir</button>
      </div>
    </header>

    <main>
      <div class="card">
        <h2>Datos del pedido</h2>
        <label>Vendedor</label>
        <select id="vendedorSel"></select><br>
        <label>Cliente</label>
        <select id="clienteSel"></select>
        <button id="btnNuevoCliente" class="btn">+ Cliente</button><br>
        <label>Fecha</label>
        <input type="date" id="fechaEmision">
      </div>

      <div class="card" style="position:relative">
        <h2>Agregar productos</h2>
        <input type="text" id="buscadorProd" placeholder="Buscar producto o c√≥digo...">
        <div id="resultadosBusqueda"></div>
        <button id="btnScanQR" class="btn">üì∑ Escanear QR/Barra</button>
        <div class="cat-buttons" id="catButtons"></div>
        <br>
        <select id="productoSel"></select>
        <input type="number" id="precioInp" placeholder="Precio">
        <input type="number" id="cantidadInp" value="1" min="1">
        <button id="btnAgregar" class="btn">Agregar</button>
      </div>

      <div class="card">
        <h2>Carrito</h2>
        <table id="carritoTabla">
          <thead>
            <tr><th>Producto</th><th class="right">Precio</th><th class="right">Cant</th><th class="right">Subtotal</th><th></th></tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="3" class="right">Total</td><td id="totalCell" class="right">0</td><td></td></tr></tfoot>
        </table>
        <button id="btnGuardar" class="btn">Guardar Pedido</button>
        <button id="btnPDF" class="btn">Generar PDF</button>
      </div>
    </main>
  </section>

  <!-- Firebase + jsPDF + QRScanner -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, runTransaction, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCr0SM_u0c4aEG_tT_CXWLcvd6alZJT44c",
      authDomain: "siondata22.firebaseapp.com",
      projectId: "siondata22",
      storageBucket: "siondata22.appspot.com",
      messagingSenderId: "946379205241",
      appId: "1:946379205241:web:0fe04a6246518451ee42a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Referencias
    const loginView=document.getElementById("loginView");
    const appView=document.getElementById("appView");
    const email=document.getElementById("email");
    const password=document.getElementById("password");
    const loginBtn=document.getElementById("loginBtn");
    const msg=document.getElementById("msg");
    const logoutBtn=document.getElementById("logoutBtn");
    const userEmail=document.getElementById("userEmail");

    const vendedorSel=document.getElementById("vendedorSel");
    const clienteSel=document.getElementById("clienteSel");
    const productoSel=document.getElementById("productoSel");
    const precioInp=document.getElementById("precioInp");
    const cantidadInp=document.getElementById("cantidadInp");
    const btnAgregar=document.getElementById("btnAgregar");
    const carritoTablaBody=document.querySelector("#carritoTabla tbody");
    const totalCell=document.getElementById("totalCell");
    const btnGuardar=document.getElementById("btnGuardar");
    const btnNuevoCliente=document.getElementById("btnNuevoCliente");
    const fechaEmision=document.getElementById("fechaEmision");
    const buscadorProd=document.getElementById("buscadorProd");
    const resultadosBusqueda=document.getElementById("resultadosBusqueda");
    const btnPDF=document.getElementById("btnPDF");
    const btnScanQR=document.getElementById("btnScanQR");
    const catButtons=document.getElementById("catButtons");

    let productosCache=[], carrito=[], categorias=[];

    const fmt=n=>new Intl.NumberFormat("es-PY").format(n||0);

    function renderCarrito(){
      carritoTablaBody.innerHTML="";
      carrito.forEach((it,idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${it.nombre}</td><td class="right">${fmt(it.precio)}</td><td class="right">${it.cantidad}</td><td class="right">${fmt(it.precio*it.cantidad)}</td><td><button data-idx="${idx}">‚ùå</button></td>`;
        tr.querySelector("button").addEventListener("click",()=>{carrito.splice(idx,1);renderCarrito()});
        carritoTablaBody.appendChild(tr);
      });
      totalCell.textContent=fmt(carrito.reduce((a,i)=>a+i.precio*i.cantidad,0));
    }

    async function cargarSelects(){
      let snap=await getDocs(query(collection(db,"vendedores"),orderBy("nombre"))); 
      vendedorSel.innerHTML='<option value="">‚Äî</option>'+snap.docs.map(d=>`<option value="${d.id}">${d.data().nombre}</option>`).join("");
      snap=await getDocs(query(collection(db,"clientes"),orderBy("nombre"))); 
      clienteSel.innerHTML='<option value="">‚Äî</option>'+snap.docs.map(d=>`<option value="${d.id}">${d.data().nombre}</option>`).join("");
      snap=await getDocs(query(collection(db,"productos"),orderBy("nombre"))); 
      productosCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      productoSel.innerHTML='<option value="">‚Äî</option>'+productosCache.map(p=>`<option value="${p.id}">${p.nombre} (${p.codigo||''})</option>`).join("");
      categorias=[...new Set(productosCache.map(p=>p.categoria).filter(Boolean))];
      catButtons.innerHTML=categorias.map(c=>`<button data-cat="${c}">${c}</button>`).join("");
      document.querySelectorAll("#catButtons button").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const cat=btn.dataset.cat;
          const match=productosCache.find(p=>p.categoria===cat);
          if(match){ productoSel.value=match.id; precioInp.value=match.precio; }
        });
      });
    }

    productoSel.addEventListener("change",()=>{
      const p=productosCache.find(x=>x.id===productoSel.value);
      if(p)precioInp.value=p.precio;
    });

    btnAgregar.addEventListener("click",()=>{
      const p=productosCache.find(x=>x.id===productoSel.value);
      if(!p)return;
      const precio=Number(precioInp.value),cant=Number(cantidadInp.value);
      carrito.push({id:p.id,nombre:p.nombre,precio,cantidad:cant});
      renderCarrito();
      resultadosBusqueda.innerHTML="";
    });

    buscadorProd.addEventListener("input",()=>{
      const q=buscadorProd.value.toLowerCase();
      if(!q){resultadosBusqueda.innerHTML="";return;}
      const filtrados=productosCache.filter(p=>p.nombre.toLowerCase().includes(q)||(p.codigo||"").toLowerCase().includes(q));
      resultadosBusqueda.innerHTML=filtrados.map(p=>`<div data-id="${p.id}">${p.nombre} - Gs ${fmt(p.precio)}</div>`).join("");
      document.querySelectorAll("#resultadosBusqueda div").forEach(div=>{
        div.addEventListener("click",()=>{
          const prod=productosCache.find(p=>p.id===div.dataset.id);
          productoSel.value=prod.id;precioInp.value=prod.precio;buscadorProd.value=prod.nombre;resultadosBusqueda.innerHTML="";
        });
      });
    });

    btnScanQR.addEventListener("click",()=>{
      const qrbox=document.createElement("div");
      qrbox.style.width="300px";qrbox.style.margin="10px auto";
      document.body.appendChild(qrbox);
      const html5QrCode = new Html5Qrcode(qrbox);
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText)=>{
        const match=productosCache.find(p=>p.codigo===decodedText);
        if(match){ productoSel.value=match.id; precioInp.value=match.precio; buscadorProd.value=match.nombre; alert("Producto detectado: "+match.nombre); }
        html5QrCode.stop(); qrbox.remove();
      });
    });

    btnGuardar.addEventListener("click",async()=>{
      if(!vendedorSel.value||!clienteSel.value||!carrito.length)return alert("Faltan datos");
      const vendedor=vendedorSel.options[vendedorSel.selectedIndex].text;
      const cliente=clienteSel.options[clienteSel.selectedIndex].text;
      const items=carrito.map(i=>({productoId:i.id,nombre:i.nombre,precio:i.precio,cantidad:i.cantidad,subtotal:i.precio*i.cantidad}));
      const total=items.reduce((a,i)=>a+i.subtotal,0);
      const fecha=fechaEmision.value||new Date().toISOString().slice(0,10);
      try{
        await runTransaction(db,async(tx)=>{
          for(const it of items){
            const ref=doc(db,"productos",it.productoId);
            const snap=await tx.get(ref);
            const stock=snap.data().stock||0;
            if(stock<it.cantidad)throw new Error("Sin stock "+it.nombre);
            tx.update(ref,{stock:stock-it.cantidad});
          }
          await addDoc(collection(db,"pedidos"),{vendedorId:vendedorSel.value,vendedorNombre:vendedor,clienteId:clienteSel.value,clienteNombre:cliente,fecha,items,total,createdAt:serverTimestamp()});
        });
        alert("Pedido guardado");
        carrito=[];renderCarrito();
      }catch(e){alert("Error: "+e.message)}
    });

    btnNuevoCliente.addEventListener("click",async()=>{
      const nombre=prompt("Nombre cliente:");if(!nombre)return;
      const ref=await addDoc(collection(db,"clientes"),{nombre,creadoEn:serverTimestamp()});
      await cargarSelects();clienteSel.value=ref.id;
    });

    btnPDF.addEventListener("click",()=>{
if(!carrito.length)return alert("Carrito vac√≠o");
const { jsPDF } = window.jspdf;
const docPdf=new jsPDF({unit:'pt'});


const fecha=fechaEmision.value||new Date().toISOString().slice(0,10);
const vendedor=vendedorSel.options[vendedorSel.selectedIndex]?.text||"";
const cliente=clienteSel.options[clienteSel.selectedIndex]?.text||"";


docPdf.setFontSize(16);
docPdf.text("Sion Productos",40,40);
docPdf.setFontSize(10);
docPdf.text(`Fecha: ${fecha}`,40,60);
docPdf.text(`Vendedor: ${vendedor}`,40,75);
docPdf.text(`Cliente: ${cliente}`,40,90);
docPdf.text("Orden de PEDIDO",500,40);


const head=[["Producto","Precio","Cant","Subtotal"]];
const body=carrito.map(i=>[i.nombre,fmt(i.precio),i.cantidad,fmt(i.precio*i.cantidad)]);
docPdf.autoTable({startY:110,head,body});
const total=carrito.reduce((a,i)=>a+i.precio*i.cantidad,0);
docPdf.text("Total Gs: "+fmt(total),400,docPdf.lastAutoTable.finalY+20);


docPdf.save("pedido.pdf");
});

    loginBtn.addEventListener("click",async()=>{
      msg.textContent="";
      try{ await signInWithEmailAndPassword(auth,email.value,password.value);}catch(e){msg.textContent="Error: "+e.message}
    });

    onAuthStateChanged(auth,user=>{
      if(user){ loginView.style.display="none"; appView.style.display="block"; userEmail.textContent=user.email; cargarSelects(); fechaEmision.value=new Date().toISOString().slice(0,10);} else { loginView.style.display="flex"; appView.style.display="none"; }
    });

    logoutBtn.addEventListener("click",()=>signOut(auth));
  </script>
</body>
</html>
